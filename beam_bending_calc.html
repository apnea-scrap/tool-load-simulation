<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tapered Fin Bending Calculator</title>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    canvas { border: 1px solid #ccc; display: block; margin: 5px 0; }
    .slider { margin: 5px 0; }
    #output { margin: 5px 0; font-weight: bold; }
    .section { margin: 15px 0; padding: 10px; border: 1px solid #aaa; border-radius: 6px; }
    .section h4 { margin: 5px 0; }
    .caption { font-size: 0.9em; color: #333; margin-top: 3px; }
  </style>
</head>
<body>
  <h3>Tapered Fin Bending Calculator</h3>

  <div class="section">
    <h4>Geometry</h4>
    <label>Layers at foot: <span id="layersFootVal">4</span></label>
    <input type="range" id="layersFoot" min="1" max="15" value="4" class="slider"><br>

    <label>Layers at tip: <span id="layersTipVal">2</span></label>
    <input type="range" id="layersTip" min="1" max="15" value="2" class="slider"><br>

    <label>Free blade length [mm]: <span id="lengthVal">250</span></label>
    <input type="range" id="length" min="100" max="600" step="10" value="250" class="slider"><br>

    <label>Blade width [mm]: <span id="widthVal">180</span></label>
    <input type="range" id="width" min="50" max="300" step="10" value="180" class="slider"><br>

    <canvas id="laminate" width="500" height="200"></canvas>
    <div class="caption">Foot (left) — Tip (right)</div>
  </div>

  <div class="section">
    <h4>Material Properties</h4>
    <label>Young's modulus E [GPa]: <span id="EVal">32</span></label>
    <input type="range" id="E" min="20" max="40" step="0.5" value="32" class="slider"><br>

    <label>Layer thickness [mm]: <span id="thicknessVal">0.35</span></label>
    <input type="range" id="thickness" min="0.2" max="0.6" step="0.01" value="0.35" class="slider"><br>
  </div>

  <div class="section">
    <h4>Bending Calculation</h4>
    <p id="output"></p>
    <canvas id="plot" width="500" height="400"></canvas>
    <div class="caption">Foot (left) — Tip (right)</div>
  </div>

  <script>
    const canvas = document.getElementById('plot');
    const ctx = canvas.getContext('2d');
    const laminateCanvas = document.getElementById('laminate');
    const lctx = laminateCanvas.getContext('2d');

    const params = { layersFoot: 4, layersTip: 2, L: 250, b: 180, E: 32, P: 40, thickness: 0.35 };
    const N = 200;

    function effectiveThicknessAt(xi) {
      // Calculate thickness considering base layers (tip) + extra layers ending at min 50 mm
      const baseLayers = params.layersTip;
      const extraLayers = params.layersFoot - params.layersTip;
      let layersHere = baseLayers;
      if (extraLayers > 0) {
        for (let i = 1; i <= extraLayers; i++) {
          const cutoff = Math.max(50, params.L * (1 - (i / extraLayers) * 0.8));
          if (xi <= cutoff) layersHere += 1;
        }
      }
      return layersHere * params.thickness;
    }

    function computeTipAngle(P) {
      const E = params.E * 1000;
      let theta = 0;
      const dx = params.L / (N - 1);
      for (let i = 0; i < N; i++) {
        let xi = i * dx;
        let hi = effectiveThicknessAt(xi);
        let Ii = params.b * Math.pow(hi, 3) / 12.0;
        let kappa = (P * (params.L - xi)) / (E * Ii);
        if (i > 0) theta += kappa * dx;
      }
      return theta * 180 / Math.PI;
    }

    function solveForLoad() {
      let P = 1;
      for (let i = 0; i < 2000; i++) {
        let angle = computeTipAngle(P);
        if (angle >= 90) return P;
        P += 1;
      }
      return P;
    }

    function drawLaminate(maxBendX) {
      lctx.clearRect(0, 0, laminateCanvas.width, laminateCanvas.height);

      const { L, b, layersTip, layersFoot } = params;
      const margin = 20;
      const lengthScale = (laminateCanvas.width - 2 * margin) / 600; // scale relative to max length
      const widthScale = (laminateCanvas.height - 2 * margin) / 300; // scale relative to max width
      const lengthPx = L * lengthScale;
      const widthPx = b * widthScale;
      const x0 = margin;
      const y0 = margin;

      // Base layers equal to tip
      for (let i = 0; i < layersTip; i++) {
        lctx.fillStyle = "rgba(0,0,200,0.3)";
        lctx.fillRect(x0, y0, lengthPx, widthPx);
        lctx.strokeStyle = "black";
        lctx.strokeRect(x0, y0, lengthPx, widthPx);
      }

      // Extra layers spaced to foot, last one max 50 mm
      const extraLayers = layersFoot - layersTip;
      if (extraLayers > 0) {
        for (let i = 1; i <= extraLayers; i++) {
          const fraction = i / extraLayers;
          const layerLength = Math.max(50, L * (1 - fraction * 0.8));
          const layerLengthPx = layerLength * lengthScale;
          lctx.fillStyle = "rgba(200,0,0,0.3)";
          lctx.fillRect(x0, y0, layerLengthPx, widthPx);
          lctx.strokeStyle = "black";
          lctx.strokeRect(x0, y0, layerLengthPx, widthPx);
        }
      }

      // Draw red line at max bending position
      if (maxBendX !== undefined) {
        const bendPos = x0 + maxBendX * lengthScale;
        lctx.strokeStyle = "red";
        lctx.beginPath();
        lctx.moveTo(bendPos, y0);
        lctx.lineTo(bendPos, y0 + widthPx);
        lctx.stroke();
      }
    }

    function update() {
      params.P = solveForLoad();
      document.getElementById('layersFootVal').textContent = params.layersFoot;
      document.getElementById('layersTipVal').textContent = params.layersTip;
      document.getElementById('lengthVal').textContent = params.L;
      document.getElementById('widthVal').textContent = params.b;
      document.getElementById('EVal').textContent = params.E;
      document.getElementById('thicknessVal').textContent = params.thickness.toFixed(2);

      const E = params.E * 1000;
      let x = [], kappa = [], theta = [];
      const dx = params.L / (N - 1);
      for (let i = 0; i < N; i++) {
        let xi = i * dx;
        let hi = effectiveThicknessAt(xi);
        let Ii = params.b * Math.pow(hi, 3) / 12.0;
        let M = params.P * (params.L - xi);
        kappa.push(M / (E * Ii));
        x.push(xi);
      }
      theta[0] = 0;
      for (let i = 1; i < N; i++) theta[i] = theta[i-1] + kappa[i] * dx;
      let X = [0], Y = [0];
      for (let i = 1; i < N; i++) {
        X.push(X[i-1] + dx * Math.cos(theta[i]));
        Y.push(Y[i-1] + dx * Math.sin(theta[i]));
      }
      const tipAngleDeg = theta[N-1] * 180 / Math.PI;
      const tipDeflection = Y[N-1];

      // Find max curvature point
      let maxKappa = -Infinity, idxMax = 0;
      for (let i = 0; i < kappa.length; i++) {
        if (kappa[i] > maxKappa) {
          maxKappa = kappa[i];
          idxMax = i;
        }
      }
      const maxX = X[idxMax];
      const maxY = Y[idxMax];
      const maxBendX = x[idxMax];

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(50, 30);
      const maxYaxis = Math.ceil(tipDeflection / 50) * 50;
      ctx.strokeStyle = 'gray';
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, maxYaxis + 20);
      ctx.moveTo(0, 0);
      ctx.lineTo(params.L + 40, 0);
      ctx.stroke();
      ctx.fillStyle = 'black';
      ctx.fillText("X (mm)", params.L/2, 20);
      ctx.fillText("Y (mm)", -30, maxYaxis + 20);
      ctx.strokeStyle = 'blue';
      ctx.beginPath();
      ctx.moveTo(X[0], Y[0]);
      for (let i = 1; i < N; i++) ctx.lineTo(X[i], Y[i]);
      ctx.stroke();

      // Red arrow at max bending point
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.moveTo(maxX, maxY);
      ctx.lineTo(maxX - 8, maxY - 15);
      ctx.lineTo(maxX + 8, maxY - 15);
      ctx.closePath();
      ctx.fill();

      ctx.restore();

      // Draw laminate with marker line
      drawLaminate(maxBendX);

      const loadKg = params.P / 9.81;
      document.getElementById('output').textContent =
        `Angle at tip = ${tipAngleDeg.toFixed(1)}°, Load at tip = ${params.P.toFixed(1)} N (${loadKg.toFixed(2)} kg)`;
    }

    document.getElementById('layersFoot').oninput = e => { params.layersFoot = +e.target.value; update(); };
    document.getElementById('layersTip').oninput  = e => { params.layersTip  = +e.target.value; update(); };
    document.getElementById('length').oninput     = e => { params.L          = +e.target.value; update(); };
    document.getElementById('width').oninput      = e => { params.b          = +e.target.value; update(); };
    document.getElementById('E').oninput          = e => { params.E          = +e.target.value; update(); };
    document.getElementById('thickness').oninput  = e => { params.thickness  = +e.target.value; update(); };

    update();
  </script>
</body>
</html>
